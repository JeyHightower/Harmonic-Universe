import{c as e}from"./vendor-redux-toolkit.fa18e013.js";import r from"./app-services-api.399edcf9.js";import{E as t,B as a,A as s}from"./app-utils.cd93f9c5.js";const i="harmonic_universe_character_cache",c=e=>{var r,t,a,s;return{message:(null==(t=null==(r=e.response)?void 0:r.data)?void 0:t.message)||e.message||"An error occurred",status:null==(a=e.response)?void 0:a.status,data:null==(s=e.response)?void 0:s.data}},n=()=>{if(!a)return!1;const e=localStorage.getItem(s.TOKEN_KEY);return e&&e.startsWith("demo-")},d=(e,r)=>{try{const t=localStorage.getItem(i),a=t?JSON.parse(t):{};a[e]={characters:r,timestamp:Date.now()},localStorage.setItem(i,JSON.stringify(a))}catch(t){}},u=e=>{try{const r=localStorage.getItem(i);if(!r)return null;const t=JSON.parse(r)[e];return t&&t.characters&&Date.now()-t.timestamp<864e5?t.characters:null}catch(r){return null}},h=e=>{try{const r=localStorage.getItem(i);if(!r)return;const t=JSON.parse(r);t[e]&&(delete t[e],localStorage.setItem(i,JSON.stringify(t)))}catch(r){}},o=e("characters/fetchCharacters",(async(e,{rejectWithValue:s})=>{var i;try{if(n())return[];return(await r.getCharactersByScene(e)).data.characters}catch(d){if(429===(null==(i=d.response)?void 0:i.status))try{return(await t({method:"get",url:`${r.defaults.baseURL}/api/characters/scene/${e}`,headers:r.defaults.headers,withCredentials:!0})).data.characters}catch(u){return a?[]:s(c(u))}return a?[]:s(c(d))}})),v=e("characters/fetchCharactersByUniverse",(async(e,{rejectWithValue:s})=>{var i,h,o;try{const t=u(e);if(t&&t.length>0)return t;if(n())return[];if(!e||void 0===e||"undefined"===e||"null"===e)return a?[]:s(`Invalid universe ID: ${e}`);const i="string"==typeof e?parseInt(e,10):e;if(isNaN(i)||i<=0)return a?[]:s(`Invalid universe ID format: ${e}`);const c=await r.getCharactersByUniverse(i);let h=[];return c.data&&c.data.characters?h=c.data.characters:Array.isArray(c.data)&&(h=c.data),h.length>0&&d(i,h),h}catch(v){if(429===(null==(i=v.response)?void 0:i.status))try{const e=`${r.defaults.baseURL}/api/universes/${parsedUniverseId}/characters`,a=await t({method:"get",url:e,headers:r.defaults.headers,withCredentials:!0});let s=[];return a.data&&a.data.characters?s=a.data.characters:Array.isArray(a.data)&&(s=a.data),s.length>0&&d(parsedUniverseId,s),s}catch(l){const r=u(e);return r||(a?[]:s(c(l)))}null==(o=null==(h=v.response)?void 0:h.data)||o.message;const n=u(e);return n||(a?[]:s(c(v)))}})),l=e("characters/fetchCharacter",(async(e,{rejectWithValue:s})=>{var i;try{if(n())return{id:e,name:"Demo Character",description:"This is a demo character",created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()};return(await r.getCharacter(e)).data.character}catch(d){if(429===(null==(i=d.response)?void 0:i.status))try{return(await t({method:"get",url:`${r.defaults.baseURL}/api/characters/${e}`,headers:r.defaults.headers,withCredentials:!0})).data.character}catch(u){return a?{id:e,name:"Mock Character",description:"This character could not be loaded",created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}:s(c(u))}return a?{id:e,name:"Mock Character",description:"This character could not be loaded",created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}:s(c(d))}})),f=e("characters/createCharacter",(async(e,{rejectWithValue:s,getState:i})=>{var u;try{if(n()){const r={id:"demo-char-"+Math.random().toString(36).substring(2,10),...e,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()};if(e.universe_id){const t=i().characters.universeCharacters[e.universe_id]||[];d(e.universe_id,[...t,r])}return e.universe_id&&h(e.universe_id),r}const t=(await r.createCharacter(e)).data.character;if(e.universe_id){const r=i().characters.universeCharacters[e.universe_id]||[];d(e.universe_id,[...r,t])}return e.universe_id&&h(e.universe_id),t}catch(o){if(429===(null==(u=o.response)?void 0:u.status))try{const a=(await t({method:"post",url:`${r.defaults.baseURL}/api/characters`,data:e,headers:r.defaults.headers,withCredentials:!0})).data.character;if(e.universe_id){const r=i().characters.universeCharacters[e.universe_id]||[];d(e.universe_id,[...r,a])}return e.universe_id&&h(e.universe_id),a}catch(v){if(a){const r={id:"mock-char-"+Math.random().toString(36).substring(2,10),...e,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()};if(e.universe_id){const t=i().characters.universeCharacters[e.universe_id]||[];d(e.universe_id,[...t,r])}return e.universe_id&&h(e.universe_id),r}return s(c(v))}if(a){const r={id:"mock-char-"+Math.random().toString(36).substring(2,10),...e,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()};if(e.universe_id){const t=i().characters.universeCharacters[e.universe_id]||[];d(e.universe_id,[...t,r])}return e.universe_id&&h(e.universe_id),r}return s(c(o))}})),_=e("characters/updateCharacter",(async({characterId:e,characterData:s},{rejectWithValue:i,getState:u})=>{var o;try{if(n()){const r={id:e,...s,updated_at:(new Date).toISOString()};if(s.universe_id){const t=u(),a=(t.characters.universeCharacters[s.universe_id]||[]).map((t=>t.id===e?r:t));d(s.universe_id,a)}return s.universe_id&&h(s.universe_id),r}const t=(await r.updateCharacter(e,s)).data.character;if(s.universe_id){const r=u(),a=(r.characters.universeCharacters[s.universe_id]||[]).map((r=>r.id===e?t:r));d(s.universe_id,a)}return s.universe_id&&h(s.universe_id),t}catch(v){if(429===(null==(o=v.response)?void 0:o.status))try{const a=(await t({method:"put",url:`${r.defaults.baseURL}/api/characters/${e}`,data:s,headers:r.defaults.headers,withCredentials:!0})).data.character;if(s.universe_id){const r=u(),t=(r.characters.universeCharacters[s.universe_id]||[]).map((r=>r.id===e?a:r));d(s.universe_id,t)}return s.universe_id&&h(s.universe_id),a}catch(l){if(a){const r={id:e,...s,updated_at:(new Date).toISOString()};if(s.universe_id){const t=(u().characters.universeCharacters[s.universe_id]||[]).map((t=>t.id===e?r:t));d(s.universe_id,t)}return s.universe_id&&h(s.universe_id),r}return i(c(l))}if(a){const r={id:e,...s,updated_at:(new Date).toISOString()};if(s.universe_id){const t=(u().characters.universeCharacters[s.universe_id]||[]).map((t=>t.id===e?r:t));d(s.universe_id,t)}return s.universe_id&&h(s.universe_id),r}return i(c(v))}})),p=e("characters/deleteCharacter",(async(e,{rejectWithValue:s,getState:i})=>{var u;try{if(n()){const r=i();return Object.keys(r.characters.universeCharacters).forEach((t=>{const a=r.characters.universeCharacters[t]||[];if(a.some((r=>r.id===e))){const r=a.filter((r=>r.id!==e));d(t,r)}})),e}await r.deleteCharacter(e);const t=i();return Object.keys(t.characters.universeCharacters).forEach((r=>{const a=t.characters.universeCharacters[r]||[];if(a.some((r=>r.id===e))){const t=a.filter((r=>r.id!==e));d(r,t)}})),e}catch(h){if(429===(null==(u=h.response)?void 0:u.status))try{await t({method:"delete",url:`${r.defaults.baseURL}/api/characters/${e}`,headers:r.defaults.headers,withCredentials:!0});const a=i();return Object.keys(a.characters.universeCharacters).forEach((r=>{const t=a.characters.universeCharacters[r]||[];if(t.some((r=>r.id===e))){const a=t.filter((r=>r.id!==e));d(r,a)}})),e}catch(o){if(a){const r=i();return Object.keys(r.characters.universeCharacters).forEach((t=>{const a=r.characters.universeCharacters[t]||[];if(a.some((r=>r.id===e))){const r=a.filter((r=>r.id!==e));d(t,r)}})),e}return s(c(o))}if(a){const r=i();return Object.keys(r.characters.universeCharacters).forEach((t=>{const a=r.characters.universeCharacters[t]||[];if(a.some((r=>r.id===e))){const r=a.filter((r=>r.id!==e));d(t,r)}})),e}return s(c(h))}}));export{o as a,v as b,f as c,p as d,l as f,_ as u};
