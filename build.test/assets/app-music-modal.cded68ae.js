import{r as e,j as a}from"./vendor-react-core.73efc664.js";import{P as s}from"./vendor-react-props.65efe0a6.js";import{M as r,I as i,c as n,B as l,d as t,e as o}from"./app-other-components.5e297c7e.js";import"./app-core.4fc76094.js";import{c as d,T as c}from"./vendor-tone-esm.8edb30e2.js";import{u as m}from"./vendor-react-router.6468192e.js";import{s as u,F as h}from"./vendor-tone-core-base.398f9a2a.js";import{P as p,S as x}from"./vendor-tone-instruments.3eb491c0.js";import{S as j}from"./vendor-tone-events.9afa7530.js";const v=({universeId:s,sceneId:v,initialData:g,onClose:y,modalProps:f={},isGlobalModal:b=!1})=>{const _=m(),[N,C]=e.useState(!1),[F,w]=e.useState(!1),[k,S]=e.useState(null),[P,A]=e.useState(null),[D,$]=e.useState(null),[M,T]=e.useState({name:"",description:"",algorithm:"harmonic_synthesis",duration:10,tempo:120,scale:"major",key:"C",parameters:{harmonicity:1,modulation_index:3,attack:.01,decay:.2,sustain:.5,release:.8,reverb_amount:.3,delay_time:.4,delay_feedback:.2}});e.useEffect((()=>{g&&(T({...g,parameters:g.parameters||M.parameters}),g.audio_url&&A(g.audio_url),g.id&&$(g.id))}),[g]);const G=e=>{const{name:a,value:s}=e.target;T((e=>({...e,[a]:s})))},R=(e,a)=>{T((s=>({...s,parameters:{...s.parameters,[e]:a}})))},E=async e=>{try{"running"!==d.state&&await u();const a=new p(x).toDestination();c.bpm.value=e.tempo||120,c.cancel();const s=new j(((e,s)=>{s&&a.triggerAttackRelease(h(s.midi,"midi").toFrequency(),s.duration||"8n",e,s.velocity||.8)}),e.notes,"8n");return s.start(0),c.start(),{synth:a,sequence:s}}catch(a){S("Failed to play music. "+a.message)}};return a.jsxs(r,{title:g?"Edit Audio":"Generate Audio",onClose:y,...f,children:[k&&a.jsx("div",{className:"error-message",children:k}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"name",children:"Name"}),a.jsx(i,{id:"name",name:"name",value:M.name,onChange:G,placeholder:"Enter a name for this audio",required:!0})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"description",children:"Description"}),a.jsx(i,{id:"description",name:"description",value:M.description,onChange:G,placeholder:"Describe this audio (optional)",multiline:!0,rows:3})]}),a.jsxs("div",{className:"form-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"algorithm",children:"Algorithm"}),a.jsx(n,{id:"algorithm",value:M.algorithm,onChange:e=>{const a={harmonic_synthesis:{harmonicity:1,modulation_index:3,attack:.01,decay:.2,sustain:.5,release:.8,reverb_amount:.3,delay_time:.4,delay_feedback:.2},granular_synthesis:{grain_size:.1,grain_spacing:.2,position:.5,spread:.2,density:50,reverb_amount:.4},physical_modeling:{stiffness:.8,damping:.2,resonance:.7,position:.5,excitation:.6}};T((s=>({...s,algorithm:e,parameters:a[e]||{}})))},options:[{value:"harmonic_synthesis",label:"Harmonic Synthesis"},{value:"granular_synthesis",label:"Granular Synthesis"},{value:"physical_modeling",label:"Physical Modeling"}]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"duration",children:"Duration (seconds)"}),a.jsx(i,{id:"duration",name:"duration",type:"number",min:1,max:60,value:M.duration,onChange:G})]})]}),a.jsxs("div",{className:"form-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"tempo",children:"Tempo (BPM)"}),a.jsx(i,{id:"tempo",name:"tempo",type:"number",min:40,max:240,value:M.tempo,onChange:G})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"key",children:"Key"}),a.jsx(n,{id:"key",value:M.key,onChange:e=>G({target:{name:"key",value:e}}),options:[{value:"C",label:"C"},{value:"C#",label:"C#"},{value:"D",label:"D"},{value:"D#",label:"D#"},{value:"E",label:"E"},{value:"F",label:"F"},{value:"F#",label:"F#"},{value:"G",label:"G"},{value:"G#",label:"G#"},{value:"A",label:"A"},{value:"A#",label:"A#"},{value:"B",label:"B"}]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"scale",children:"Scale"}),a.jsx(n,{id:"scale",value:M.scale,onChange:e=>G({target:{name:"scale",value:e}}),options:[{value:"major",label:"Major"},{value:"minor",label:"Minor"},{value:"harmonic_minor",label:"Harmonic Minor"},{value:"melodic_minor",label:"Melodic Minor"},{value:"dorian",label:"Dorian"},{value:"phrygian",label:"Phrygian"},{value:"lydian",label:"Lydian"},{value:"mixolydian",label:"Mixolydian"},{value:"locrian",label:"Locrian"},{value:"pentatonic_major",label:"Pentatonic Major"},{value:"pentatonic_minor",label:"Pentatonic Minor"},{value:"blues",label:"Blues"}]})]})]}),(()=>{const{algorithm:e}=M;switch(e){case"harmonic_synthesis":return a.jsxs("div",{className:"parameters-fieldset",children:[a.jsx("legend",{children:"Harmonic Synthesis Parameters"}),a.jsxs("div",{className:"form-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"harmonicity",children:"Harmonicity"}),a.jsx(o,{id:"harmonicity",min:.1,max:10,step:.1,value:M.parameters.harmonicity,onChange:e=>R("harmonicity",e)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"modulation_index",children:"Modulation Index"}),a.jsx(o,{id:"modulation_index",min:0,max:10,step:.1,value:M.parameters.modulation_index,onChange:e=>R("modulation_index",e)})]})]}),a.jsxs("div",{className:"form-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"attack",children:"Attack (s)"}),a.jsx(o,{id:"attack",min:.001,max:2,step:.001,value:M.parameters.attack,onChange:e=>R("attack",e)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"decay",children:"Decay (s)"}),a.jsx(o,{id:"decay",min:.001,max:2,step:.001,value:M.parameters.decay,onChange:e=>R("decay",e)})]})]}),a.jsxs("div",{className:"form-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"sustain",children:"Sustain"}),a.jsx(o,{id:"sustain",min:0,max:1,step:.01,value:M.parameters.sustain,onChange:e=>R("sustain",e)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"release",children:"Release (s)"}),a.jsx(o,{id:"release",min:.001,max:5,step:.001,value:M.parameters.release,onChange:e=>R("release",e)})]})]}),a.jsxs("div",{className:"form-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"reverb_amount",children:"Reverb Amount"}),a.jsx(o,{id:"reverb_amount",min:0,max:1,step:.01,value:M.parameters.reverb_amount,onChange:e=>R("reverb_amount",e)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"delay_time",children:"Delay Time (s)"}),a.jsx(o,{id:"delay_time",min:0,max:1,step:.01,value:M.parameters.delay_time,onChange:e=>R("delay_time",e)})]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"delay_feedback",children:"Delay Feedback"}),a.jsx(o,{id:"delay_feedback",min:0,max:.9,step:.01,value:M.parameters.delay_feedback,onChange:e=>R("delay_feedback",e)})]})]});case"granular_synthesis":return a.jsxs("div",{className:"parameters-fieldset",children:[a.jsx("legend",{children:"Granular Synthesis Parameters"}),a.jsxs("div",{className:"form-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"grain_size",children:"Grain Size (s)"}),a.jsx(o,{id:"grain_size",min:.01,max:1,step:.01,value:M.parameters.grain_size,onChange:e=>R("grain_size",e)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"grain_spacing",children:"Grain Spacing (s)"}),a.jsx(o,{id:"grain_spacing",min:.01,max:1,step:.01,value:M.parameters.grain_spacing,onChange:e=>R("grain_spacing",e)})]})]}),a.jsxs("div",{className:"form-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"position",children:"Position"}),a.jsx(o,{id:"position",min:0,max:1,step:.01,value:M.parameters.position,onChange:e=>R("position",e)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"spread",children:"Spread"}),a.jsx(o,{id:"spread",min:0,max:1,step:.01,value:M.parameters.spread,onChange:e=>R("spread",e)})]})]}),a.jsxs("div",{className:"form-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"density",children:"Density"}),a.jsx(o,{id:"density",min:1,max:100,step:1,value:M.parameters.density,onChange:e=>R("density",e)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"reverb_amount",children:"Reverb Amount"}),a.jsx(o,{id:"reverb_amount",min:0,max:1,step:.01,value:M.parameters.reverb_amount,onChange:e=>R("reverb_amount",e)})]})]})]});case"physical_modeling":return a.jsxs("div",{className:"parameters-fieldset",children:[a.jsx("legend",{children:"Physical Modeling Parameters"}),a.jsxs("div",{className:"form-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"stiffness",children:"Stiffness"}),a.jsx(o,{id:"stiffness",min:.1,max:1,step:.01,value:M.parameters.stiffness,onChange:e=>R("stiffness",e)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"damping",children:"Damping"}),a.jsx(o,{id:"damping",min:0,max:1,step:.01,value:M.parameters.damping,onChange:e=>R("damping",e)})]})]}),a.jsxs("div",{className:"form-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"resonance",children:"Resonance"}),a.jsx(o,{id:"resonance",min:0,max:1,step:.01,value:M.parameters.resonance,onChange:e=>R("resonance",e)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"position",children:"Position"}),a.jsx(o,{id:"position",min:0,max:1,step:.01,value:M.parameters.position,onChange:e=>R("position",e)})]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:"excitation",children:"Excitation"}),a.jsx(o,{id:"excitation",min:0,max:1,step:.01,value:M.parameters.excitation,onChange:e=>R("excitation",e)})]})]});default:return a.jsx("p",{children:"Select an algorithm to view parameters"})}})(),P?a.jsxs("div",{className:"audio-player",children:[a.jsx("h3",{children:"Preview"}),a.jsx("audio",{controls:!0,src:P,style:{width:"100%"},children:"Your browser does not support the audio element."})]}):null,a.jsxs("div",{className:"form-actions",children:[a.jsx(l,{onClick:async()=>{w(!0),S(null);try{const e=`/api/universes/${s}/generate-music`;let a="";if("harmonic_synthesis"===M.algorithm){const e={tempo:M.tempo,scale_type:M.scale,root_note:M.key,melody_complexity:M.parameters.modulation_index/10};a=`?custom_params=${encodeURIComponent(JSON.stringify(e))}`}const r=await fetch(e+a),i=await r.json();i.music_data?(i.audio_url&&A(i.audio_url),T((e=>({...e,generated_data:i.music_data}))),i.music_data.notes&&E(i.music_data)):i.error?S(i.error):S("Failed to generate audio preview")}catch(e){S(e.message||"Failed to generate audio preview")}finally{w(!1)}},variant:"secondary",disabled:F||N,children:F?a.jsxs(a.Fragment,{children:[a.jsx(t,{size:"small"})," Generating..."]}):"Generate Preview"}),a.jsx(l,{onClick:y,variant:"outline",disabled:N,children:"Cancel"}),a.jsx(l,{onClick:async()=>{if(M.name.trim()){C(!0),S(null);try{if(!M.generated_data)return S("Please generate a preview first"),void C(!1);const e={name:M.name,description:M.description||"",universe_id:s,scene_id:v||null,music_data:M.generated_data,settings:{algorithm:M.algorithm,tempo:M.tempo,scale:M.scale,key:M.key,parameters:M.parameters}},a=`/api/universes/${s}/save-music`,r=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),i=await r.json();i.id||i.success?(null==y||y(),!b&&i.id&&_(`/universes/${s}/scenes/${v}/audio/${i.id}`)):i.error?S(i.error):S("Failed to save audio")}catch(e){S(e.message||"Failed to save audio")}finally{C(!1)}}else S("Name is required")},variant:"primary",disabled:N,children:N?a.jsxs(a.Fragment,{children:[a.jsx(t,{size:"small"})," Saving..."]}):g?"Update":"Save"})]})]})};v.propTypes={universeId:s.string.isRequired,sceneId:s.string.isRequired,initialData:s.object,onClose:s.func,modalProps:s.object,isGlobalModal:s.bool},v.defaultProps={initialData:null,onClose:()=>{},modalProps:{},isGlobalModal:!1};const g=Object.freeze(Object.defineProperty({__proto__:null,default:v},Symbol.toStringTag,{value:"Module"})),y=({universeId:s,sceneId:i,audioId:n,onClose:o,modalProps:d={},isGlobalModal:c=!1})=>{var u,h;const p=m(),[x,j]=e.useState(!0),[v,g]=e.useState(null),[y,f]=e.useState(null),[b,_]=e.useState(!1),[N,C]=e.useState(0),[F,w]=e.useState(0),k=e.useRef(null),S=e.useRef(null),P=e.useRef(null);e.useEffect((()=>((async()=>{j(!0),g(null);try{const e=await fetch(`/api/universes/${s}/music/${n}`);if(!e.ok){const a=await e.json();throw new Error(a.error||"Failed to fetch audio data")}const a=await e.json();f(a),k.current&&(k.current.src=a.audio_url,k.current.load())}catch(e){g(e.message||"An error occurred while fetching audio data")}finally{j(!1)}})(),()=>{P.current&&cancelAnimationFrame(P.current)})),[n,s,i]);const A=()=>{if(k.current){if(C(k.current.currentTime),S.current){const e=k.current.currentTime/k.current.duration*100;S.current.style.width=`${e}%`}P.current=requestAnimationFrame(A)}},D=e=>{if(isNaN(e))return"0:00";const a=Math.floor(e/60),s=Math.floor(e%60);return`${a}:${s<10?"0":""}${s}`};return a.jsxs(r,{...d,onClose:o,className:"audio-details-modal",children:[a.jsx("div",{className:"modal-header",children:a.jsx("h2",{children:d.title||(y?`Audio: ${y.name}`:"Audio Details")})}),a.jsx("div",{className:"modal-body",children:x?a.jsxs("div",{className:"loading-container",children:[a.jsx(t,{size:"medium"}),a.jsx("p",{children:"Loading audio data..."})]}):v?a.jsx("div",{className:"error-message",children:v}):y?a.jsxs("div",{className:"audio-details",children:[a.jsxs("div",{className:"audio-info",children:[a.jsxs("p",{children:[a.jsx("strong",{children:"Name:"})," ",y.name]}),a.jsxs("p",{children:[a.jsx("strong",{children:"Description:"})," ",y.description||"No description provided"]}),a.jsxs("p",{children:[a.jsx("strong",{children:"Algorithm:"})," ",(null==(u=y.algorithm)?void 0:u.replace(/_/g," "))||"Unknown"]}),a.jsxs("p",{children:[a.jsx("strong",{children:"Duration:"})," ",D(y.duration||0)]}),a.jsxs("p",{children:[a.jsx("strong",{children:"Key:"})," ",y.key||"C"]}),a.jsxs("p",{children:[a.jsx("strong",{children:"Scale:"})," ",(null==(h=y.scale)?void 0:h.replace(/_/g," "))||"major"]}),a.jsxs("div",{className:"parameters-section",children:[a.jsx("h3",{children:"Parameters"}),($=y.parameters,$&&0!==Object.keys($).length?a.jsx("ul",{className:"parameters-list",children:Object.entries($).map((([e,s])=>a.jsxs("li",{children:[a.jsxs("strong",{children:[e.replace(/_/g," "),":"]})," ","number"==typeof s?s.toFixed(2):s]},e)))}):a.jsx("p",{children:"No parameters available"}))]})]}),a.jsxs("div",{className:"audio-player",children:[a.jsx("audio",{ref:k,onTimeUpdate:()=>{if(k.current&&(C(k.current.currentTime),S.current&&k.current.duration)){const e=k.current.currentTime/k.current.duration*100;S.current.style.width=`${e}%`}},onDurationChange:()=>{k.current&&w(k.current.duration)},onEnded:()=>{_(!1),k.current&&(k.current.currentTime=0)},preload:"metadata"}),a.jsxs("div",{className:"player-controls",children:[a.jsx(l,{variant:"icon",onClick:()=>{k.current&&(b?(k.current.pause(),cancelAnimationFrame(P.current)):(k.current.play(),P.current=requestAnimationFrame(A)),_(!b))},className:"play-button","aria-label":b?"Pause":"Play",children:b?"❚❚":"▶"}),a.jsxs("div",{className:"time-display",children:[D(N)," / ",D(F)]})]}),a.jsxs("div",{className:"progress-container",onClick:e=>{if(!k.current||!S.current)return;const a=e.currentTarget.getBoundingClientRect(),s=(e.clientX-a.left)/a.width,r=s*k.current.duration;k.current.currentTime=r,C(r),S.current&&(S.current.style.width=100*s+"%")},"aria-label":"Audio progress",role:"progressbar","aria-valuemin":"0","aria-valuemax":F,"aria-valuenow":N,children:[a.jsx("div",{className:"progress-background"}),a.jsx("div",{className:"progress-bar",ref:S})]})]})]}):a.jsx("div",{className:"empty-state",children:"No audio data available"})}),a.jsxs("div",{className:"modal-footer",children:[a.jsx(l,{variant:"secondary",onClick:()=>{null==o||o(),p(c?`/modal/audio/edit/${n}?universe_id=${s}&scene_id=${i}`:`/universes/${s}/scenes/${i}/audio/${n}/edit`)},children:"Edit Audio"}),a.jsx(l,{variant:"danger",onClick:async()=>{if(confirm("Are you sure you want to delete this audio track? This action cannot be undone.")){j(!0),g(null);try{const e=await fetch(`/api/universes/${s}/music/${n}`,{method:"DELETE"});if(!e.ok){const a=await e.json();throw new Error(a.error||"Failed to delete audio")}null==o||o(),c||p(`/universes/${s}/scenes/${i}`)}catch(e){g(e.message||"Failed to delete audio"),j(!1)}}},children:"Delete Audio"}),a.jsx(l,{variant:"outline",onClick:o,children:"Close"})]})]});var $};y.propTypes={universeId:s.string.isRequired,sceneId:s.string.isRequired,audioId:s.string.isRequired,onClose:s.func,modalProps:s.object,isGlobalModal:s.bool},y.defaultProps={onClose:()=>{},modalProps:{},isGlobalModal:!1};const f=Object.freeze(Object.defineProperty({__proto__:null,default:y},Symbol.toStringTag,{value:"Module"}));export{g as A,f as a};
